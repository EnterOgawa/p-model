# CHSH 不等式：前提と「選別（selection）」の数式化

## 目的

この文書では、CHSH 不等式が成立するために必要な前提を整理し、
time-tag（検出時刻）に基づく同時計数選別（coincidence / pairing）が入ったときに、
CHSH の不等式（S ≤ 2）が「適用できない」形で破れ得る条件を数式で明示する。

本プロジェクト（P-model）の主張は、
「ベル違反＝非局所性」を直ちに結論する前に、
**観測手続き（time-tag 選別）が暗黙に置いている“同一母集団”仮定**を一次データで検証すべき、という立場である。

---

## 1) CHSH の標準形と前提（最小）

測定設定を a ∈ {0,1}, b ∈ {0,1}、結果を A ∈ {±1}, B ∈ {±1} とし、
隠れ変数を λ とする。

標準的な局所隠れ変数（LHV）では、

$$
A = A(a,\\lambda), \\quad B = B(b,\\lambda)
$$

であり、以下を仮定する：

1. **局所性（パラメータ独立）**：A は b に依らず、B は a に依らない  
2. **測定独立（自由選択）**：ρ(λ|a,b) = ρ(λ)  
3. **同一母集団（平均の同定）**：各 (a,b) で観測する期待値が、同一の ρ(λ) 上の平均として定義できる  

このとき

$$
E(a,b) = \\int d\\lambda \\, \\rho(\\lambda) \\, A(a,\\lambda)B(b,\\lambda)
$$

および

$$
S \\equiv \\left| E(0,0) + E(0,1) + E(1,0) - E(1,1) \\right| \\le 2
$$

が導かれる（CHSH 不等式）。

---

## 2) 「選別（selection）」が入った観測量は条件付き平均になる

ベル実験では、実データに対して何らかの **採否判定** が入ることが多い。
典型例は time-tag に基づく同時計数選別：

$$
\\text{keep} \\iff |t_A - t_B - \\delta| < \\Delta
$$

ここで keep を表す二値変数を s ∈ {0,1} と置く。

このとき、観測される相関は一般に

$$
E_{\\text{obs}}(a,b) = \\mathbb{E}[AB\\mid s=1, a,b]
$$

という **条件付き平均**になる。

局所モデルであっても、s が (a,b,λ) に依存しうるため、
次の形で書ける：

$$
E_{\\text{obs}}(a,b)
=
\\frac{
\\int d\\lambda\\, \\rho(\\lambda)\\, w_{ab}(\\lambda)\\,A(a,\\lambda)B(b,\\lambda)
}{
\\int d\\lambda\\, \\rho(\\lambda)\\, w_{ab}(\\lambda)
}
$$

ただし

$$
w_{ab}(\\lambda) \\equiv \\Pr(s=1\\mid a,b,\\lambda)
$$

である。

重要点は、**(a,b) ごとに有効な λ 分布が変わり得る**こと：

$$
\\rho_{ab}(\\lambda) \\propto \\rho(\\lambda)\\,w_{ab}(\\lambda)
$$

つまり、(a,b) の4通りで「同一母集団の平均」という前提が崩れる可能性がある。

---

## 3) 独立確率仮定が破れる条件（数式）

CHSH の導出に必要な「同一母集団」の条件を、選別関数 w_{ab}(λ) の言葉で書くと：

$$
\\rho_{00}(\\lambda)=\\rho_{01}(\\lambda)=\\rho_{10}(\\lambda)=\\rho_{11}(\\lambda)
\\quad (\\text{同一母集団})
$$

十分条件の一つは、

$$
w_{00}(\\lambda)=w_{01}(\\lambda)=w_{10}(\\lambda)=w_{11}(\\lambda)
$$

（少なくとも比例関係：正規化で打ち消せる差だけ）である。

逆に、(a,b) によって w_{ab}(λ) が異なるなら、
観測される 4 つの相関 E_obs(a,b) はそれぞれ **異なる条件付き分布**で計算される。
このとき、同一の λ に対して (A0,A1,B0,B1) を同時に割り当てる（CHSH の標準導出）ことが、観測量としては正当化できない。

---

## 4) time-tag（時刻）選別が w_{ab}(λ) を生む

time-tag に基づく選別では、

$$
t_A = f_A(a,\\lambda,\\eta_A), \\quad t_B = f_B(b,\\lambda,\\eta_B)
$$

（η は局所雑音）という **局所関数**であっても、

$$
s = 1\\left[|t_A - t_B - \\delta| < \\Delta\\right]
$$

が導入されることで、w_{ab}(λ) が (a,b) に依存し得る。

P-model の観点では、t_A, t_B の揺らぎに
「局所装置遅延 ×（局所の時間構造）」が入ると、選別が中立ではなくなる（＝同一母集団が崩れる）入口が生じる。

この “入口” は、一次データの解析として
- setting と click delay（sync基準）の分布差
- coincidence window / pairing の変更に対する統計量の安定性

として検証できる（Step 7.4 の目的）。
