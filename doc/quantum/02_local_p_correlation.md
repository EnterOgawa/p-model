# Step 7.2：局所P構造による相関生成（最小モデル）

目的：
- Step 7.4（ベル不等式）に入る前に、「相関」がどこから生まれるかを **局所モデル**として明文化する。
- 特に、ベルテストで現れる “同時計数（coincidence）選別” が、測定設定に依存した集合の入れ替え（post-selection）を起こし得る点を、数式と再現可能デモで固定する。

本Stepは「量子状態の否定」ではなく、
**ベル不等式の適用前提（同一母集団平均）**が、時刻タグ選別で破れ得ることを定量化する準備である。

参照（ブリーフ）：
- `doc/quantum/P-model_BellTest_AI_Brief.md`

---

## 1. 最小の局所モデル（イベント生成）

1回のイベント（ペア）について、共有パラメータ（hidden variable）として位相 λ を導入し、
各観測点（A/B）の測定設定を θ_A, θ_B とする。

局所モデルの要素は次の2つに分ける。

1) **出力（±1）**  
各側は局所的に x_A(λ,θ_A), x_B(λ,θ_B) を返す（非局所依存は入れない）。

2) **検出時刻タグ（time-tag）**  
各側は局所的に t_A(λ,θ_A), t_B(λ,θ_B) を生成する。
P-model の立場では、この time-tag が「局所P × 装置条件（光路/遅延/検出器応答）」で変調され得る、という点が核心になる。

ここで重要なのは、相関評価で使うデータが **全イベントではなく**

$$
|t_A-t_B| < \\Delta t
$$

を満たすものだけ（同時計数）に選別される、という観測手続きである。

もし t_A, t_B が測定設定に依存して分布を変えると、
採用集合（coincidence set）が (θ_A,θ_B) ごとに変化し、ベル不等式が暗黙に仮定する「同一母集団平均」が成立しなくなる。

---

## 2. 何を示すべきか（Step 7.4 への要件）

Step 7.4（一次データ）で検証するために、本Stepで固定すべき出力は次の通り。

- CHSH の S 値が、同時計数窓 Δt の関数として系統的に変化すること（S(Δt)）。
- trial-based（パルス番号など）でペア定義した場合に S が変わること。
- time-tag アルゴリズム（閾値、補間、分解能）を変えると S が変わること。

これらが **観測的に不変**であれば、この機構（time-tag × 選別）でベル違反を説明する案は棄却される。

---

## 3. 再現可能デモ（toy）：選別により S が変化し得る

本リポジトリでは、まず “局所モデル＋時刻タグ＋同時計数選別” だけで
S が変化し得ることを toy simulation として固定する。

- スクリプト：`scripts/quantum/bell_time_tag_selection_sweep.py`
- 出力：
  - `output/quantum/bell_time_tag_selection_sweep.png`
  - `output/quantum/bell_time_tag_selection_sweep_metrics.json`

再現：
- `python -B scripts/quantum/bell_time_tag_selection_sweep.py`

注意：
- この toy は「P-model が正しい」ことを示すものではない。
- “どの仮定が必要か／何が観測で棄却されるか” を整理する足場である。

